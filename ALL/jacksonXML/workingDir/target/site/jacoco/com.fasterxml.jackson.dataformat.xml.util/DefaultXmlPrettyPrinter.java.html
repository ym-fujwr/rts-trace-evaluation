<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultXmlPrettyPrinter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jackson-dataformat-XML</a> &gt; <a href="index.source.html" class="el_package">com.fasterxml.jackson.dataformat.xml.util</a> &gt; <span class="el_source">DefaultXmlPrettyPrinter.java</span></div><h1>DefaultXmlPrettyPrinter.java</h1><pre class="source lang-java linenums">package com.fasterxml.jackson.dataformat.xml.util;

import java.io.IOException;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.Arrays;

import javax.xml.XMLConstants;
import javax.xml.stream.XMLStreamException;

import org.codehaus.stax2.XMLStreamWriter2;

import com.fasterxml.jackson.core.*;
import com.fasterxml.jackson.core.util.Instantiatable;

import com.fasterxml.jackson.dataformat.xml.XmlPrettyPrinter;
import com.fasterxml.jackson.dataformat.xml.ser.ToXmlGenerator;

/**
 * Indentation to use with XML is different from JSON, because JSON
 * requires use of separator characters and XML just basic whitespace.
 *&lt;p&gt;
 * Note that only a subset of methods of {@link PrettyPrinter} actually
 * get called by {@link ToXmlGenerator}; because of this, implementation
 * is bit briefer (and uglier...).
 */
public class DefaultXmlPrettyPrinter
    implements XmlPrettyPrinter, Instantiatable&lt;DefaultXmlPrettyPrinter&gt;,
        java.io.Serializable
{
    private static final long serialVersionUID = 1L; // since 2.6

    /**
     * Interface that defines objects that can produce indentation used
     * to separate object entries and array values. Indentation in this
     * context just means insertion of white space, independent of whether
     * linefeeds are output.
     */
    public interface Indenter
    {
        public void writeIndentation(JsonGenerator g, int level) throws IOException;

        public void writeIndentation(XMLStreamWriter2 sw, int level) throws XMLStreamException;

        /**
         * @return True if indenter is considered inline (does not add linefeeds),
         *   false otherwise
         */
        public boolean isInline();
    }

    /*
    /**********************************************************
    /* Configuration
    /**********************************************************
     */

    /**
     * By default, let's use only spaces to separate array values.
     */
<span class="fc" id="L61">    protected Indenter _arrayIndenter = new FixedSpaceIndenter();</span>

    /**
     * By default, let's use linefeed-adding indenter for separate
     * object entries. We'll further configure indenter to use
     * system-specific linefeeds, and 2 spaces per level (as opposed to,
     * say, single tabs)
     */
<span class="fc" id="L69">    protected Indenter _objectIndenter = new Lf2SpacesIndenter();</span>

    // // // Config, other white space configuration

    /**
     * By default, will try to set as System.getProperty(&quot;line.separator&quot;).
     * Can later set custom new line with withCustomNewLine method.
     * @since 2.15
     */
    private static final String SYSTEM_DEFAULT_NEW_LINE;
    static {
<span class="fc" id="L80">        String lf = null;</span>
        try {
<span class="fc" id="L82">            lf = System.getProperty(&quot;line.separator&quot;);</span>
<span class="pc" id="L83">        } catch (Exception t) { } // access exception?</span>
<span class="fc" id="L84">        SYSTEM_DEFAULT_NEW_LINE = lf;</span>
    }
<span class="fc" id="L86">    protected String _newLine = SYSTEM_DEFAULT_NEW_LINE;</span>

    static final int SPACE_COUNT = 64;
<span class="fc" id="L89">    static final char[] SPACES = new char[SPACE_COUNT];</span>
    static {
<span class="fc" id="L91">        Arrays.fill(SPACES, ' ');</span>
<span class="fc" id="L92">    }</span>

    /*
    /**********************************************************
    /* State
    /**********************************************************
    */
    
    /**
     * Number of open levels of nesting. Used to determine amount of
     * indentation to use.
     */
<span class="fc" id="L104">    protected transient int _nesting = 0;</span>

    /**
     * Marker flag set on start element, and cleared if an end element
     * is encountered. Used for suppressing indentation to allow empty
     * elements.
     * 
     * @since 2.3
     */
    protected transient boolean _justHadStartElement;
    
    /*
    /**********************************************************
    /* Life-cycle (construct, configure)
    /**********************************************************
    */

<span class="fc" id="L121">    public DefaultXmlPrettyPrinter() { }</span>

    protected DefaultXmlPrettyPrinter(DefaultXmlPrettyPrinter base)
<span class="fc" id="L124">    {</span>
<span class="fc" id="L125">        _arrayIndenter = base._arrayIndenter;</span>
<span class="fc" id="L126">        _objectIndenter = base._objectIndenter;</span>
<span class="fc" id="L127">        _nesting = base._nesting;</span>
<span class="fc" id="L128">        _newLine = base._newLine;</span>
<span class="fc" id="L129">    }</span>

    public void indentArraysWith(Indenter i)
    {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        _arrayIndenter = (i == null) ? new NopIndenter() : i;</span>
<span class="nc" id="L134">    }</span>

    public void indentObjectsWith(Indenter i)
    {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        _objectIndenter = (i == null) ? new NopIndenter() : i;</span>
<span class="nc" id="L139">    }</span>

    /**
     * Sets custom new-line.
     * @since 2.15
     */
    public DefaultXmlPrettyPrinter withCustomNewLine(String newLine) {
<span class="fc bfc" id="L146" title="All 2 branches covered.">        _newLine = newLine != null ? newLine : SYSTEM_DEFAULT_NEW_LINE;</span>
<span class="fc" id="L147">        return this;</span>
    }

    /*
    /**********************************************************
    /* Instantiatable impl
    /**********************************************************
     */
    
    @Override
    public DefaultXmlPrettyPrinter createInstance() {
<span class="fc" id="L158">        return new DefaultXmlPrettyPrinter(this);</span>
    }

    /*
    /**********************************************************
    /* PrettyPrinter impl
    /**********************************************************
     */

    @Override
    public void writeRootValueSeparator(JsonGenerator gen) throws IOException {
        // Not sure if this should ever be applicable; but if multiple roots were allowed, we'd use linefeed
<span class="nc" id="L170">        gen.writeRaw('\n');</span>
<span class="nc" id="L171">    }</span>

    /*
    /**********************************************************
    /* Array values
    /**********************************************************
     */

    @Override
    public void beforeArrayValues(JsonGenerator gen) throws IOException {
        // never called for ToXmlGenerator
<span class="nc" id="L182">    }</span>

    @Override
    public void writeStartArray(JsonGenerator gen) throws IOException {
        // anything to do here?
<span class="fc" id="L187">    }</span>

    @Override
    public void writeArrayValueSeparator(JsonGenerator gen)  throws IOException {
        // never called for ToXmlGenerator
<span class="nc" id="L192">    }</span>

    @Override
    public void writeEndArray(JsonGenerator gen, int nrOfValues) throws IOException {
        // anything to do here?
<span class="fc" id="L197">    }</span>

    /*
    /**********************************************************
    /* Object values
    /**********************************************************
     */

    @Override
    public void beforeObjectEntries(JsonGenerator gen)
        throws IOException, JsonGenerationException
    {
        // never called for ToXmlGenerator
<span class="nc" id="L210">    }</span>

    @Override
    public void writeStartObject(JsonGenerator gen) throws IOException
    {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (_nesting &gt; 0) {</span>
<span class="fc" id="L217">                _objectIndenter.writeIndentation(gen, _nesting);</span>
            }
<span class="fc" id="L219">            ++_nesting;</span>
        }
<span class="fc" id="L221">        _justHadStartElement = true;</span>
<span class="fc" id="L222">        ((ToXmlGenerator) gen)._handleStartObject();</span>
<span class="fc" id="L223">    }</span>

    @Override
    public void writeObjectEntrySeparator(JsonGenerator gen) throws IOException {
        // never called for ToXmlGenerator
<span class="nc" id="L228">    }</span>

    @Override
    public void writeObjectFieldValueSeparator(JsonGenerator gen) throws IOException {
        // never called for ToXmlGenerator
<span class="nc" id="L233">    }</span>

    @Override
    public void writeEndObject(JsonGenerator gen, int nrOfEntries) throws IOException
    {
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L239">            --_nesting;</span>
        }
        // for empty elements, no need for linefeeds etc:
<span class="fc bfc" id="L242" title="All 2 branches covered.">        if (_justHadStartElement) {</span>
<span class="fc" id="L243">            _justHadStartElement = false;</span>
        } else {
<span class="fc" id="L245">            _objectIndenter.writeIndentation(gen, _nesting);</span>
        }
<span class="fc" id="L247">        ((ToXmlGenerator) gen)._handleEndObject();</span>
<span class="fc" id="L248">    }</span>

    /*
    /**********************************************************
    /* XML-specific additions
    /**********************************************************
     */

    @Override
    public void writeStartElement(XMLStreamWriter2 sw,
            String nsURI, String localName) throws XMLStreamException
    {
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">            if (_justHadStartElement) {</span>
<span class="fc" id="L262">                _justHadStartElement = false;</span>
            }
<span class="fc" id="L264">            _objectIndenter.writeIndentation(sw, _nesting);</span>
<span class="fc" id="L265">            ++_nesting;</span>
        }
<span class="fc" id="L267">        sw.writeStartElement(nsURI, localName);</span>
<span class="fc" id="L268">        _justHadStartElement = true;        </span>
<span class="fc" id="L269">    }</span>

    @Override
    public void writeEndElement(XMLStreamWriter2 sw, int nrOfEntries) throws XMLStreamException
    {
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L275">            --_nesting;</span>
        }
        // for empty elements, no need for linefeeds etc:
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (_justHadStartElement) {</span>
<span class="nc" id="L279">            _justHadStartElement = false;</span>
        } else {
<span class="fc" id="L281">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L283">        sw.writeEndElement();</span>
<span class="fc" id="L284">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
    		String nsURI, String localName, String text, boolean isCData)
  		throws XMLStreamException
    {
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L292">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L294">        sw.writeStartElement(nsURI, localName);</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">        if(isCData) {</span>
<span class="nc" id="L296">            sw.writeCData(text);</span>
        } else {
<span class="fc" id="L298">            sw.writeCharacters(text);</span>
        }
<span class="fc" id="L300">        sw.writeEndElement();</span>
<span class="fc" id="L301">        _justHadStartElement = false;</span>
<span class="fc" id="L302">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
    		String nsURI, String localName,
    		char[] buffer, int offset, int len, boolean isCData)
        throws XMLStreamException
    {
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L311">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L313">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        if(isCData) {</span>
<span class="nc" id="L315">            sw.writeCData(buffer, offset, len);</span>
        } else {
<span class="nc" id="L317">            sw.writeCharacters(buffer, offset, len);</span>
        }
<span class="nc" id="L319">        sw.writeEndElement();</span>
<span class="nc" id="L320">        _justHadStartElement = false;</span>
<span class="nc" id="L321">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
    		String nsURI, String localName, boolean value)
  		throws XMLStreamException
    {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L329">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L331">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc" id="L332">        sw.writeBoolean(value);</span>
<span class="nc" id="L333">        sw.writeEndElement();</span>
<span class="nc" id="L334">        _justHadStartElement = false;</span>
<span class="nc" id="L335">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
            String nsURI, String localName, int value)
        throws XMLStreamException
    {
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L343">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L345">        sw.writeStartElement(nsURI, localName);</span>
<span class="fc" id="L346">        sw.writeInt(value);</span>
<span class="fc" id="L347">        sw.writeEndElement();</span>
<span class="fc" id="L348">        _justHadStartElement = false;</span>
<span class="fc" id="L349">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
            String nsURI, String localName, long value)
        throws XMLStreamException
    {
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L357">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L359">        sw.writeStartElement(nsURI, localName);</span>
<span class="fc" id="L360">        sw.writeLong(value);</span>
<span class="fc" id="L361">        sw.writeEndElement();</span>
<span class="fc" id="L362">        _justHadStartElement = false;</span>
<span class="fc" id="L363">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
            String nsURI, String localName, double value)
  		throws XMLStreamException
    {
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L371">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L373">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc" id="L374">        sw.writeDouble(value);</span>
<span class="nc" id="L375">        sw.writeEndElement();</span>
<span class="nc" id="L376">        _justHadStartElement = false;</span>
<span class="nc" id="L377">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
    		String nsURI, String localName, float value)
  		throws XMLStreamException
    {
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L385">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L387">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc" id="L388">        sw.writeFloat(value);</span>
<span class="nc" id="L389">        sw.writeEndElement();</span>
<span class="nc" id="L390">        _justHadStartElement = false;</span>
<span class="nc" id="L391">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
            String nsURI, String localName, BigInteger value)
        throws XMLStreamException
    {
<span class="nc bnc" id="L398" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L399">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L401">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc" id="L402">        sw.writeInteger(value);</span>
<span class="nc" id="L403">        sw.writeEndElement();</span>
<span class="nc" id="L404">        _justHadStartElement = false;</span>
<span class="nc" id="L405">    }</span>

    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
    		String nsURI, String localName, BigDecimal value)
  		throws XMLStreamException
    {
<span class="nc bnc" id="L412" title="All 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="nc" id="L413">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="nc" id="L415">        sw.writeStartElement(nsURI, localName);</span>
<span class="nc" id="L416">        sw.writeDecimal(value);</span>
<span class="nc" id="L417">        sw.writeEndElement();</span>
<span class="nc" id="L418">        _justHadStartElement = false;</span>
<span class="nc" id="L419">    }</span>

    // method definition changed in 2.12
    @Override
    public void writeLeafElement(XMLStreamWriter2 sw,
            String nsURI, String localName,
            org.codehaus.stax2.typed.Base64Variant base64variant,
            byte[] data, int offset, int len)
        throws XMLStreamException
    {
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L430">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L432">        sw.writeStartElement(nsURI, localName);</span>
<span class="fc" id="L433">        sw.writeBinary(base64variant, data, offset, len);</span>
<span class="fc" id="L434">        sw.writeEndElement();</span>
<span class="fc" id="L435">        _justHadStartElement = false;</span>
<span class="fc" id="L436">    }</span>

    @Override
    public void writeLeafNullElement(XMLStreamWriter2 sw,
            String nsURI, String localName)
        throws XMLStreamException
    {
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L444">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L446">        sw.writeEmptyElement(nsURI, localName);</span>
<span class="fc" id="L447">        _justHadStartElement = false;</span>
<span class="fc" id="L448">    }</span>

    // @since 2.12
    public void writeLeafXsiNilElement(XMLStreamWriter2 sw,
            String nsURI, String localName)
        throws XMLStreamException
    {
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (!_objectIndenter.isInline()) {</span>
<span class="fc" id="L456">            _objectIndenter.writeIndentation(sw, _nesting);</span>
        }
<span class="fc" id="L458">        sw.writeEmptyElement(nsURI, localName);</span>
<span class="fc" id="L459">        sw.writeAttribute(&quot;xsi&quot;, XMLConstants.W3C_XML_SCHEMA_INSTANCE_NS_URI, &quot;nil&quot;, &quot;true&quot;);</span>
<span class="fc" id="L460">        _justHadStartElement = false;    </span>
<span class="fc" id="L461">    }</span>

    @Override // since 2.7
    public void writePrologLinefeed(XMLStreamWriter2 sw) throws XMLStreamException
    {
        // 06-Dec-2015, tatu: Alternatively could try calling `writeSpace()`...
<span class="fc" id="L467">        sw.writeRaw(_newLine);</span>
<span class="fc" id="L468">    }</span>

    /*
    /**********************************************************
    /* Helper classes
    /* (note: copied from jackson-core to avoid dependency;
    /* allow local changes)
    /**********************************************************
     */

    /**
     * Dummy implementation that adds no indentation whatsoever
     */
    protected static class NopIndenter
        implements Indenter, java.io.Serializable
    {
        private static final long serialVersionUID = 1L;

<span class="nc" id="L486">        public NopIndenter() { }</span>
<span class="nc" id="L487">        @Override public void writeIndentation(JsonGenerator jg, int level) { }</span>
<span class="nc" id="L488">        @Override public boolean isInline() { return true; }</span>
<span class="nc" id="L489">        @Override public void writeIndentation(XMLStreamWriter2 sw, int level) { }</span>
    }

    /**
     * This is a very simple indenter that only every adds a
     * single space for indentation. It is used as the default
     * indenter for array values.
     */
    protected static class FixedSpaceIndenter
        implements Indenter, java.io.Serializable
    {
        private static final long serialVersionUID = 1L;

<span class="fc" id="L502">        public FixedSpaceIndenter() { }</span>

        @Override
        public void writeIndentation(XMLStreamWriter2 sw, int level)
            throws XMLStreamException
        {
<span class="nc" id="L508">            sw.writeRaw(&quot; &quot;);</span>
<span class="nc" id="L509">        }</span>

        @Override
        public void writeIndentation(JsonGenerator g, int level) throws IOException
        {
<span class="nc" id="L514">            g.writeRaw(' ');</span>
<span class="nc" id="L515">        }</span>

        @Override
<span class="nc" id="L518">        public boolean isInline() { return true; }</span>
    }

    /**
     * Default linefeed-based indenter uses system-specific linefeeds and
     * 2 spaces for indentation per level.
     */
    protected class Lf2SpacesIndenter
        implements Indenter, java.io.Serializable
    {
        private static final long serialVersionUID = 1L;

<span class="fc" id="L530">        public Lf2SpacesIndenter() { }</span>

        @Override
<span class="fc" id="L533">        public boolean isInline() { return false; }</span>

        @Override
        public void writeIndentation(XMLStreamWriter2 sw, int level) throws XMLStreamException
        {
<span class="fc" id="L538">            sw.writeRaw(_newLine);</span>
<span class="fc" id="L539">            level += level; // 2 spaces per level</span>
<span class="pc bpc" id="L540" title="1 of 2 branches missed.">            while (level &gt; SPACE_COUNT) { // should never happen but...</span>
<span class="nc" id="L541">            	sw.writeRaw(SPACES, 0, SPACE_COUNT); </span>
<span class="nc" id="L542">                level -= SPACES.length;</span>
            }
<span class="fc" id="L544">            sw.writeRaw(SPACES, 0, level);</span>
<span class="fc" id="L545">        }</span>

        @Override
        public void writeIndentation(JsonGenerator jg, int level) throws IOException
        {
<span class="fc" id="L550">            jg.writeRaw(_newLine);</span>
<span class="fc" id="L551">            level += level; // 2 spaces per level</span>
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">            while (level &gt; SPACE_COUNT) { // should never happen but...</span>
<span class="nc" id="L553">                jg.writeRaw(SPACES, 0, SPACE_COUNT); </span>
<span class="nc" id="L554">                level -= SPACES.length;</span>
            }
<span class="fc" id="L556">            jg.writeRaw(SPACES, 0, level);</span>
<span class="fc" id="L557">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>