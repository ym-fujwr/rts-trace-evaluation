<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XmlMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jackson-dataformat-XML</a> &gt; <a href="index.source.html" class="el_package">com.fasterxml.jackson.dataformat.xml</a> &gt; <span class="el_source">XmlMapper.java</span></div><h1>XmlMapper.java</h1><pre class="source lang-java linenums">package com.fasterxml.jackson.dataformat.xml;

import java.io.IOException;

import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLOutputFactory;
import javax.xml.stream.XMLStreamReader;
import javax.xml.stream.XMLStreamWriter;

import com.fasterxml.jackson.core.*;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.*;
import com.fasterxml.jackson.databind.cfg.CoercionAction;
import com.fasterxml.jackson.databind.cfg.CoercionInputShape;
import com.fasterxml.jackson.databind.cfg.MapperBuilder;
import com.fasterxml.jackson.databind.deser.BeanDeserializerFactory;
import com.fasterxml.jackson.databind.jsontype.PolymorphicTypeValidator;
import com.fasterxml.jackson.databind.jsontype.TypeResolverBuilder;
import com.fasterxml.jackson.databind.type.LogicalType;
import com.fasterxml.jackson.dataformat.xml.deser.FromXmlParser;
import com.fasterxml.jackson.dataformat.xml.deser.XmlDeserializationContext;
import com.fasterxml.jackson.dataformat.xml.ser.ToXmlGenerator;
import com.fasterxml.jackson.dataformat.xml.ser.XmlSerializerProvider;
import com.fasterxml.jackson.dataformat.xml.util.DefaultXmlPrettyPrinter;
import com.fasterxml.jackson.dataformat.xml.util.XmlRootNameLookup;

/**
 * Customized {@link ObjectMapper} that will read and write XML instead of JSON,
 * using XML-backed {@link com.fasterxml.jackson.core.JsonFactory}
 * implementation ({@link XmlFactory}).
 *&lt;p&gt;
 * Mapper itself overrides some aspects of functionality to try to handle
 * data binding aspects as similar to JAXB as possible.
 *&lt;p&gt;
 * Note that most of configuration should be done by pre-constructing
 * {@link JacksonXmlModule} explicitly, instead of relying on default settings.
 */
public class XmlMapper extends ObjectMapper
{
    // as of 2.6
    private static final long serialVersionUID = 1L;

    /**
     * Builder implementation for constructing {@link XmlMapper} instances.
     *
     * @since 2.10
     */
    public static class Builder extends MapperBuilder&lt;XmlMapper, Builder&gt;
    {
        public Builder(XmlMapper m) {
<span class="fc" id="L51">            super(m);</span>
<span class="fc" id="L52">        }</span>

        public Builder enable(FromXmlParser.Feature... features)  {
<span class="fc bfc" id="L55" title="All 2 branches covered.">            for (FromXmlParser.Feature f : features) {</span>
<span class="fc" id="L56">                _mapper.enable(f);</span>
            }
<span class="fc" id="L58">            return this;</span>
        }

        public Builder disable(FromXmlParser.Feature... features) {
<span class="fc bfc" id="L62" title="All 2 branches covered.">            for (FromXmlParser.Feature f : features) {</span>
<span class="fc" id="L63">                _mapper.disable(f);</span>
            }
<span class="fc" id="L65">            return this;</span>
        }

        public Builder configure(FromXmlParser.Feature feature, boolean state)
        {
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (state) {</span>
<span class="nc" id="L71">                _mapper.enable(feature);</span>
            } else {
<span class="nc" id="L73">                _mapper.disable(feature);</span>
            }
<span class="nc" id="L75">            return this;</span>
        }

        public Builder enable(ToXmlGenerator.Feature... features) {
<span class="fc bfc" id="L79" title="All 2 branches covered.">            for (ToXmlGenerator.Feature f : features) {</span>
<span class="fc" id="L80">                _mapper.enable(f);</span>
            }
<span class="fc" id="L82">            return this;</span>
        }

        public Builder disable(ToXmlGenerator.Feature... features) {
<span class="fc bfc" id="L86" title="All 2 branches covered.">            for (ToXmlGenerator.Feature f : features) {</span>
<span class="fc" id="L87">                _mapper.disable(f);</span>
            }
<span class="fc" id="L89">            return this;</span>
        }

        public Builder configure(ToXmlGenerator.Feature feature, boolean state)
        {
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (state) {</span>
<span class="fc" id="L95">                _mapper.enable(feature);</span>
            } else {
<span class="nc" id="L97">                _mapper.disable(feature);</span>
            }
<span class="fc" id="L99">            return this;</span>
        }
        
        public Builder nameForTextElement(String name) {
<span class="fc" id="L103">            _mapper.setXMLTextElementName(name);</span>
<span class="fc" id="L104">            return this;</span>
        }

        public Builder defaultUseWrapper(boolean state) {
<span class="fc" id="L108">            _mapper.setDefaultUseWrapper(state);</span>
<span class="fc" id="L109">            return this;</span>
        }

        /**
         * @since 2.14
         */
        public Builder xmlNameProcessor(XmlNameProcessor processor) {
<span class="fc" id="L116">            _mapper.setXmlNameProcessor(processor);</span>
<span class="fc" id="L117">            return this;</span>
        }
    }

<span class="fc" id="L121">    protected final static JacksonXmlModule DEFAULT_XML_MODULE = new JacksonXmlModule();</span>

<span class="fc" id="L123">    protected final static DefaultXmlPrettyPrinter DEFAULT_XML_PRETTY_PRINTER = new DefaultXmlPrettyPrinter();</span>

    // need to hold on to module instance just in case copy() is used
    protected final JacksonXmlModule _xmlModule;

    /*
    /**********************************************************
    /* Life-cycle: construction, configuration
    /**********************************************************
     */

    public XmlMapper() {
<span class="fc" id="L135">        this(new XmlFactory());</span>
<span class="fc" id="L136">    }</span>

    /**
     * @since 2.4
     */
    public XmlMapper(XMLInputFactory inputF, XMLOutputFactory outF) {
<span class="nc" id="L142">        this(new XmlFactory(inputF, outF));</span>
<span class="nc" id="L143">    }</span>

    /**
     * @since 2.4
     */
    public XmlMapper(XMLInputFactory inputF) {
<span class="fc" id="L149">        this(new XmlFactory(inputF));</span>
<span class="fc" id="L150">    }</span>

    public XmlMapper(XmlFactory xmlFactory) {
<span class="fc" id="L153">        this(xmlFactory, DEFAULT_XML_MODULE);</span>
<span class="fc" id="L154">    }</span>

    public XmlMapper(JacksonXmlModule module) {
<span class="fc" id="L157">        this(new XmlFactory(), module);</span>
<span class="fc" id="L158">    }</span>

    public XmlMapper(XmlFactory xmlFactory, JacksonXmlModule module)
    {
        // Need to override serializer provider (due to root name handling);
        // deserializer provider fine as is
<span class="fc" id="L164">        super(xmlFactory, new XmlSerializerProvider(new XmlRootNameLookup()),</span>
                new XmlDeserializationContext(BeanDeserializerFactory.instance));
<span class="fc" id="L166">        _xmlModule = module;</span>
        // but all the rest is done via Module interface!
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (module != null) {</span>
<span class="fc" id="L169">            registerModule(module);</span>
        }
        // 19-May-2015, tatu: Must ensure we use XML-specific indenter
<span class="fc" id="L172">        _serializationConfig = _serializationConfig.withDefaultPrettyPrinter(DEFAULT_XML_PRETTY_PRINTER);</span>
        // 21-Jun-2017, tatu: Seems like there are many cases in XML where ability to coerce empty
        //    String into `null` (where it otherwise is an error) is very useful.
<span class="fc" id="L175">        enable(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT);</span>

        // 13-May-2020, tatu: [dataformat-xml#377] Need to ensure we will keep XML-specific
        //    Base64 default as &quot;MIME&quot; (not MIME-NO-LINEFEEDS), to preserve pre-2.12
        //    behavior
<span class="fc" id="L180">        setBase64Variant(Base64Variants.MIME);</span>

        // 04-Jun-2020, tatu: Use new (2.12) &quot;CoercionConfigs&quot; to support coercion
        //   from empty and blank Strings to &quot;empty&quot; POJOs etc
<span class="fc" id="L184">        coercionConfigDefaults()</span>
            // To allow indentation without problems, need to accept blank String as empty:
<span class="fc" id="L186">            .setAcceptBlankAsEmpty(Boolean.TRUE)</span>
            // and then coercion from empty String to empty value, in general
<span class="fc" id="L188">            .setCoercion(CoercionInputShape.EmptyString, CoercionAction.AsEmpty)</span>
            ;
        // 03-May-2021, tatu: ... except make sure to keep &quot;empty to Null&quot; for
        //   scalar types...
<span class="fc" id="L192">        coercionConfigFor(LogicalType.Integer)</span>
<span class="fc" id="L193">            .setCoercion(CoercionInputShape.EmptyString, CoercionAction.AsNull);</span>
<span class="fc" id="L194">        coercionConfigFor(LogicalType.Float)</span>
<span class="fc" id="L195">            .setCoercion(CoercionInputShape.EmptyString, CoercionAction.AsNull);</span>
<span class="fc" id="L196">        coercionConfigFor(LogicalType.Boolean)</span>
<span class="fc" id="L197">            .setCoercion(CoercionInputShape.EmptyString, CoercionAction.AsNull);</span>
<span class="fc" id="L198">    }</span>

    /**
     * @since 2.8.9
     */
    protected XmlMapper(XmlMapper src) {
<span class="fc" id="L204">        super(src);</span>
<span class="fc" id="L205">        _xmlModule = src._xmlModule;</span>
<span class="fc" id="L206">    }</span>

    @Override
    public XmlMapper copy()
    {
<span class="fc" id="L211">        _checkInvalidCopy(XmlMapper.class);</span>
<span class="fc" id="L212">        return new XmlMapper(this);</span>
    }

    /**
     * @since 2.10
     */
    public static XmlMapper.Builder xmlBuilder() {
<span class="nc" id="L219">        return new XmlMapper.Builder(new XmlMapper());</span>
    }

    /**
     * @since 2.10
     */
    public static XmlMapper.Builder builder() {
<span class="fc" id="L226">        return new XmlMapper.Builder(new XmlMapper());</span>
    }

    /**
     * @since 2.10
     */
    public static XmlMapper.Builder builder(XmlFactory streamFactory) {
<span class="fc" id="L233">        return new XmlMapper.Builder(new XmlMapper(streamFactory));</span>
    }

    @Override
    public Version version() {
<span class="fc" id="L238">        return PackageVersion.VERSION;</span>
    }

    /*
    /**********************************************************
    /* Factory method overrides
    /**********************************************************
     */

    @Override // since 2.10
    protected TypeResolverBuilder&lt;?&gt; _constructDefaultTypeResolverBuilder(DefaultTyping applicability,
            PolymorphicTypeValidator ptv) {
<span class="fc" id="L250">        return new DefaultingXmlTypeResolverBuilder(applicability, ptv);</span>
    }

    /*
    /**********************************************************
    /* Additional XML-specific configurations
    /**********************************************************
     */

    /**
     * Method called by {@link JacksonXmlModule} to pass configuration
     * information to {@link XmlFactory}, during registration; NOT
     * exposed as public method since configuration should be done
     * via {@link JacksonXmlModule}.
     * 
     * @since 2.1
     *
     * @deprecated Since 2.10 use {@link Builder#nameForTextElement(String)} instead
     */
    @Deprecated
    protected void setXMLTextElementName(String name) {
<span class="fc" id="L271">        ((XmlFactory) _jsonFactory).setXMLTextElementName(name);</span>
<span class="fc" id="L272">    }</span>

    /**
     * Since 2.7
     * 
     * @deprecated Since 2.10 use {@link Builder#defaultUseWrapper(boolean)} instead
     */
    @Deprecated
    public XmlMapper setDefaultUseWrapper(boolean state) {
        // ser and deser configs should usually have the same introspector, so:
<span class="fc" id="L282">        AnnotationIntrospector ai0 = getDeserializationConfig().getAnnotationIntrospector();</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">        for (AnnotationIntrospector ai : ai0.allIntrospectors()) {</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">            if (ai instanceof JacksonXmlAnnotationIntrospector) {</span>
<span class="fc" id="L285">                ((JacksonXmlAnnotationIntrospector) ai).setDefaultUseWrapper(state);</span>
            }
<span class="fc" id="L287">        }</span>
<span class="fc" id="L288">        return this;</span>
    }

    /**
     * @since 2.14
     */
    public void setXmlNameProcessor(XmlNameProcessor processor) {
<span class="fc" id="L295">        ((XmlFactory)_jsonFactory).setXmlNameProcessor(processor);</span>
<span class="fc" id="L296">    }</span>

    /*
    /**********************************************************
    /* Access to configuration settings
    /**********************************************************
     */

    @Override
    public XmlFactory getFactory() {
<span class="fc" id="L306">        return (XmlFactory) _jsonFactory;</span>
    }
    
    public ObjectMapper configure(ToXmlGenerator.Feature f, boolean state) {
<span class="fc" id="L310">        ((XmlFactory)_jsonFactory).configure(f, state);</span>
<span class="fc" id="L311">        return this;</span>
    }

    public ObjectMapper configure(FromXmlParser.Feature f, boolean state) {
<span class="nc" id="L315">        ((XmlFactory)_jsonFactory).configure(f, state);</span>
<span class="nc" id="L316">        return this;</span>
    }

    public ObjectMapper enable(ToXmlGenerator.Feature f) {
<span class="fc" id="L320">        ((XmlFactory)_jsonFactory).enable(f);</span>
<span class="fc" id="L321">        return this;</span>
    }

    public ObjectMapper enable(FromXmlParser.Feature f) {
<span class="fc" id="L325">        ((XmlFactory)_jsonFactory).enable(f);</span>
<span class="fc" id="L326">        return this;</span>
    }

    public ObjectMapper disable(ToXmlGenerator.Feature f) {
<span class="fc" id="L330">        ((XmlFactory)_jsonFactory).disable(f);</span>
<span class="fc" id="L331">        return this;</span>
    }

    public ObjectMapper disable(FromXmlParser.Feature f) {
<span class="fc" id="L335">        ((XmlFactory)_jsonFactory).disable(f);</span>
<span class="fc" id="L336">        return this;</span>
    }

    /*
    /**********************************************************
    /* XML-specific access
    /**********************************************************
     */

    /**
     * Method for reading a single XML value from given XML-specific input
     * source; useful for incremental data-binding, combining traversal using
     * basic Stax {@link XMLStreamReader} with data-binding by Jackson.
     * 
     * @since 2.4
     */
    public &lt;T&gt; T readValue(XMLStreamReader r, Class&lt;T&gt; valueType) throws IOException {
<span class="fc" id="L353">        return readValue(r, _typeFactory.constructType(valueType));</span>
    } 

    /**
     * Method for reading a single XML value from given XML-specific input
     * source; useful for incremental data-binding, combining traversal using
     * basic Stax {@link XMLStreamReader} with data-binding by Jackson.
     * 
     * @since 2.4
     */
    public &lt;T&gt; T readValue(XMLStreamReader r, TypeReference&lt;T&gt; valueTypeRef) throws IOException {
<span class="nc" id="L364">        return readValue(r, _typeFactory.constructType(valueTypeRef));</span>
    } 

    /**
     * Method for reading a single XML value from given XML-specific input
     * source; useful for incremental data-binding, combining traversal using
     * basic Stax {@link XMLStreamReader} with data-binding by Jackson.
     * 
     * @since 2.4
     */
    @SuppressWarnings(&quot;resource&quot;)
    public &lt;T&gt; T readValue(XMLStreamReader r, JavaType valueType) throws IOException
    {
<span class="fc" id="L377">        FromXmlParser p = getFactory().createParser(r);</span>
<span class="fc" id="L378">        return super.readValue(p,  valueType);</span>
    } 

    /**
     * Method for serializing given value using specific {@link XMLStreamReader}:
     * useful when building large XML files by binding individual items, one at
     * a time.
     * 
     * @since 2.4
     */
    public void writeValue(XMLStreamWriter w0, Object value) throws IOException {
        @SuppressWarnings(&quot;resource&quot;)
<span class="fc" id="L390">        ToXmlGenerator g = getFactory().createGenerator(w0);</span>
<span class="fc" id="L391">        super.writeValue(g, value);</span>
        // NOTE: above call should do flush(); and we should NOT close here.
        // Finally, 'g' has no buffers to release.
<span class="fc" id="L394">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>