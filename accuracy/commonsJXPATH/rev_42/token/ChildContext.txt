package
org
.
apache
.
commons
.
jxpath
.
ri
.
axes
;
import
org
.
apache
.
commons
.
jxpath
.
Pointer
;
import
org
.
apache
.
commons
.
jxpath
.
ri
.
EvalContext
;
import
org
.
apache
.
commons
.
jxpath
.
ri
.
compiler
.
NodeTest
;
import
org
.
apache
.
commons
.
jxpath
.
ri
.
model
.
NodeIterator
;
import
org
.
apache
.
commons
.
jxpath
.
ri
.
model
.
NodePointer
;
public
class
ChildContext
extends
EvalContext
{
private
final
NodeTest
nodeTest
;
private
final
boolean
startFromParentLocation
;
private
final
boolean
reverse
;
private
NodeIterator
iterator
;
public
ChildContext
(
final
EvalContext
parentContext
,
final
NodeTest
nodeTest
,
final
boolean
startFromParentLocation
,
final
boolean
reverse
)
{
super
(
parentContext
)
;
this
.
nodeTest
=
nodeTest
;
this
.
startFromParentLocation
=
startFromParentLocation
;
this
.
reverse
=
reverse
;
}
@
Override
public
NodePointer
getCurrentNodePointer
(
)
{
if
(
position
==
0
&&
!
setPosition
(
1
)
)
{
return
null
;
}
return
iterator
==
null
?
null
:
iterator
.
getNodePointer
(
)
;
}
@
Override
public
Pointer
getSingleNodePointer
(
)
{
if
(
position
==
0
)
{
while
(
nextSet
(
)
)
{
prepare
(
)
;
if
(
iterator
==
null
)
{
return
null
;
}
final
NodePointer
pointer
=
iterator
.
getNodePointer
(
)
;
if
(
pointer
!=
null
)
{
return
pointer
;
}
}
return
null
;
}
return
getCurrentNodePointer
(
)
;
}
@
Override
public
boolean
nextNode
(
)
{
return
setPosition
(
getCurrentPosition
(
)
+
1
)
;
}
@
Override
public
void
reset
(
)
{
super
.
reset
(
)
;
iterator
=
null
;
}
@
Override
public
boolean
setPosition
(
final
int
position
)
{
final
int
oldPosition
=
getCurrentPosition
(
)
;
super
.
setPosition
(
position
)
;
if
(
oldPosition
==
0
)
{
prepare
(
)
;
}
return
iterator
!=
null
&&
iterator
.
setPosition
(
position
)
;
}
private
void
prepare
(
)
{
final
NodePointer
parent
=
parentContext
.
getCurrentNodePointer
(
)
;
if
(
parent
==
null
)
{
return
;
}
final
NodePointer
useParent
=
startFromParentLocation
?
parent
.
getParent
(
)
:
parent
;
iterator
=
useParent
==
null
?
null
:
useParent
.
childIterator
(
nodeTest
,
reverse
,
startFromParentLocation
?
parent
:
null
)
;
}
}
<EOF>
