package
com
.
zaxxer
.
nuprocess
.
internal
;
import
com
.
sun
.
jna
.
LastErrorException
;
public
class
ReferenceCountedFileDescriptor
{
private
int
fd
;
private
int
fdRefCount
;
private
boolean
closePending
;
public
ReferenceCountedFileDescriptor
(
int
fd
)
{
this
.
fd
=
fd
;
this
.
fdRefCount
=
0
;
this
.
closePending
=
false
;
}
protected
void
finalize
(
)
{
close
(
)
;
}
public
synchronized
int
acquire
(
)
{
fdRefCount
++
;
return
fd
;
}
public
synchronized
void
release
(
)
{
fdRefCount
--
;
if
(
fdRefCount
==
0
&&
closePending
&&
fd
!=
-
1
)
{
doClose
(
)
;
}
}
public
synchronized
void
close
(
)
{
if
(
fd
==
-
1
||
closePending
)
{
return
;
}
if
(
fdRefCount
==
0
)
{
doClose
(
)
;
}
else
{
closePending
=
true
;
}
}
private
void
doClose
(
)
{
try
{
LibC
.
close
(
fd
)
;
fd
=
-
1
;
}
catch
(
LastErrorException
e
)
{
throw
new
RuntimeException
(
e
)
;
}
}
}
<EOF>
