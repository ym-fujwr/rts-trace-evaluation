package
org
.
apache
.
commons
.
jxpath
.
ri
.
model
.
beans
;
import
java
.
beans
.
IndexedPropertyDescriptor
;
import
java
.
beans
.
PropertyDescriptor
;
import
org
.
apache
.
commons
.
jxpath
.
JXPathBeanInfo
;
import
org
.
apache
.
commons
.
jxpath
.
JXPathContext
;
import
org
.
apache
.
commons
.
jxpath
.
JXPathInvalidAccessException
;
import
org
.
apache
.
commons
.
jxpath
.
ri
.
model
.
NodePointer
;
import
org
.
apache
.
commons
.
jxpath
.
util
.
ValueUtils
;
public
class
BeanPropertyPointer
extends
PropertyPointer
{
private
static
final
long
serialVersionUID
=
-
6008991447676468786L
;
private
static
final
Object
UNINITIALIZED
=
new
Object
(
)
;
private
String
propertyName
;
private
final
JXPathBeanInfo
beanInfo
;
private
Object
baseValue
=
UNINITIALIZED
;
private
Object
value
=
UNINITIALIZED
;
private
transient
String
[
]
names
;
private
transient
PropertyDescriptor
[
]
propertyDescriptors
;
private
transient
PropertyDescriptor
propertyDescriptor
;
public
BeanPropertyPointer
(
final
NodePointer
parent
,
final
JXPathBeanInfo
beanInfo
)
{
super
(
parent
)
;
this
.
beanInfo
=
beanInfo
;
}
@
Override
public
boolean
isContainer
(
)
{
return
true
;
}
@
Override
public
int
getPropertyCount
(
)
{
if
(
beanInfo
.
isAtomic
(
)
)
{
return
0
;
}
return
getPropertyDescriptors
(
)
.
length
;
}
@
Override
public
String
[
]
getPropertyNames
(
)
{
if
(
names
==
null
)
{
final
PropertyDescriptor
[
]
pds
=
getPropertyDescriptors
(
)
;
names
=
new
String
[
pds
.
length
]
;
for
(
int
i
=
0
;
i
<
names
.
length
;
i
++
)
{
names
[
i
]
=
pds
[
i
]
.
getName
(
)
;
}
}
return
names
;
}
@
Override
public
void
setPropertyName
(
final
String
propertyName
)
{
setPropertyIndex
(
UNSPECIFIED_PROPERTY
)
;
this
.
propertyName
=
propertyName
;
}
@
Override
public
void
setPropertyIndex
(
final
int
index
)
{
if
(
propertyIndex
!=
index
)
{
super
.
setPropertyIndex
(
index
)
;
propertyName
=
null
;
propertyDescriptor
=
null
;
baseValue
=
UNINITIALIZED
;
value
=
UNINITIALIZED
;
}
}
@
Override
public
Object
getBaseValue
(
)
{
if
(
baseValue
==
UNINITIALIZED
)
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
==
null
)
{
return
null
;
}
baseValue
=
ValueUtils
.
getValue
(
getBean
(
)
,
pd
)
;
}
return
baseValue
;
}
@
Override
public
void
setIndex
(
final
int
index
)
{
if
(
this
.
index
==
index
)
{
return
;
}
if
(
this
.
index
!=
WHOLE_COLLECTION
||
index
!=
0
||
isCollection
(
)
)
{
super
.
setIndex
(
index
)
;
value
=
UNINITIALIZED
;
}
}
@
Override
public
Object
getImmediateNode
(
)
{
if
(
value
==
UNINITIALIZED
)
{
if
(
index
==
WHOLE_COLLECTION
)
{
value
=
ValueUtils
.
getValue
(
getBaseValue
(
)
)
;
}
else
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
==
null
)
{
value
=
null
;
}
else
{
value
=
ValueUtils
.
getValue
(
getBean
(
)
,
pd
,
index
)
;
}
}
}
return
value
;
}
@
Override
protected
boolean
isActualProperty
(
)
{
return
getPropertyDescriptor
(
)
!=
null
;
}
@
Override
public
boolean
isCollection
(
)
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
==
null
)
{
return
false
;
}
if
(
pd
instanceof
IndexedPropertyDescriptor
)
{
return
true
;
}
final
int
hint
=
ValueUtils
.
getCollectionHint
(
pd
.
getPropertyType
(
)
)
;
if
(
hint
==
-
1
)
{
return
false
;
}
if
(
hint
==
1
)
{
return
true
;
}
final
Object
value
=
getBaseValue
(
)
;
return
value
!=
null
&&
ValueUtils
.
isCollection
(
value
)
;
}
@
Override
public
int
getLength
(
)
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
==
null
)
{
return
1
;
}
if
(
pd
instanceof
IndexedPropertyDescriptor
)
{
return
ValueUtils
.
getIndexedPropertyLength
(
getBean
(
)
,
(
IndexedPropertyDescriptor
)
pd
)
;
}
final
int
hint
=
ValueUtils
.
getCollectionHint
(
pd
.
getPropertyType
(
)
)
;
if
(
hint
==
-
1
)
{
return
1
;
}
return
super
.
getLength
(
)
;
}
@
Override
public
void
setValue
(
final
Object
value
)
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
==
null
)
{
throw
new
JXPathInvalidAccessException
(
"Cannot set property: "
+
asPath
(
)
+
" - no such property"
)
;
}
if
(
index
==
WHOLE_COLLECTION
)
{
ValueUtils
.
setValue
(
getBean
(
)
,
pd
,
value
)
;
}
else
{
ValueUtils
.
setValue
(
getBean
(
)
,
pd
,
index
,
value
)
;
}
this
.
value
=
value
;
}
@
Override
public
NodePointer
createPath
(
final
JXPathContext
context
)
{
if
(
getImmediateNode
(
)
==
null
)
{
super
.
createPath
(
context
)
;
baseValue
=
UNINITIALIZED
;
value
=
UNINITIALIZED
;
}
return
this
;
}
@
Override
public
void
remove
(
)
{
if
(
index
==
WHOLE_COLLECTION
)
{
setValue
(
null
)
;
}
else
if
(
isCollection
(
)
)
{
final
Object
o
=
getBaseValue
(
)
;
final
Object
collection
=
ValueUtils
.
remove
(
getBaseValue
(
)
,
index
)
;
if
(
collection
!=
o
)
{
ValueUtils
.
setValue
(
getBean
(
)
,
getPropertyDescriptor
(
)
,
collection
)
;
}
}
else
if
(
index
==
0
)
{
index
=
WHOLE_COLLECTION
;
setValue
(
null
)
;
}
}
@
Override
public
String
getPropertyName
(
)
{
if
(
propertyName
==
null
)
{
final
PropertyDescriptor
pd
=
getPropertyDescriptor
(
)
;
if
(
pd
!=
null
)
{
propertyName
=
pd
.
getName
(
)
;
}
}
return
propertyName
!=
null
?
propertyName
:
"*"
;
}
private
PropertyDescriptor
getPropertyDescriptor
(
)
{
if
(
propertyDescriptor
==
null
)
{
final
int
inx
=
getPropertyIndex
(
)
;
if
(
inx
==
UNSPECIFIED_PROPERTY
)
{
propertyDescriptor
=
beanInfo
.
getPropertyDescriptor
(
propertyName
)
;
}
else
{
final
PropertyDescriptor
[
]
propertyDescriptors
=
getPropertyDescriptors
(
)
;
if
(
inx
>=
0
&&
inx
<
propertyDescriptors
.
length
)
{
propertyDescriptor
=
propertyDescriptors
[
inx
]
;
}
else
{
propertyDescriptor
=
null
;
}
}
}
return
propertyDescriptor
;
}
protected
synchronized
PropertyDescriptor
[
]
getPropertyDescriptors
(
)
{
if
(
propertyDescriptors
==
null
)
{
propertyDescriptors
=
beanInfo
.
getPropertyDescriptors
(
)
;
}
return
propertyDescriptors
;
}
}
<EOF>
