package
org
.
apache
.
commons
.
jxpath
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
Iterator
;
import
java
.
util
.
List
;
import
java
.
util
.
Map
;
import
java
.
util
.
Set
;
public
class
FunctionLibrary
implements
Functions
{
private
final
List
allFunctions
=
new
ArrayList
(
)
;
private
Map
byNamespace
;
public
void
addFunctions
(
final
Functions
functions
)
{
allFunctions
.
add
(
functions
)
;
synchronized
(
this
)
{
byNamespace
=
null
;
}
}
public
void
removeFunctions
(
final
Functions
functions
)
{
allFunctions
.
remove
(
functions
)
;
synchronized
(
this
)
{
byNamespace
=
null
;
}
}
@
Override
public
Set
getUsedNamespaces
(
)
{
return
functionCache
(
)
.
keySet
(
)
;
}
@
Override
public
Function
getFunction
(
final
String
namespace
,
final
String
name
,
final
Object
[
]
parameters
)
{
final
Object
candidates
=
functionCache
(
)
.
get
(
namespace
)
;
if
(
candidates
instanceof
Functions
)
{
return
(
(
Functions
)
candidates
)
.
getFunction
(
namespace
,
name
,
parameters
)
;
}
if
(
candidates
instanceof
List
)
{
final
List
list
=
(
List
)
candidates
;
final
int
count
=
list
.
size
(
)
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
final
Function
function
=
(
(
Functions
)
list
.
get
(
i
)
)
.
getFunction
(
namespace
,
name
,
parameters
)
;
if
(
function
!=
null
)
{
return
function
;
}
}
}
return
null
;
}
private
synchronized
Map
functionCache
(
)
{
if
(
byNamespace
==
null
)
{
byNamespace
=
new
HashMap
(
)
;
final
int
count
=
allFunctions
.
size
(
)
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
final
Functions
funcs
=
(
Functions
)
allFunctions
.
get
(
i
)
;
final
Set
namespaces
=
funcs
.
getUsedNamespaces
(
)
;
for
(
final
Iterator
it
=
namespaces
.
iterator
(
)
;
it
.
hasNext
(
)
;
)
{
final
String
ns
=
(
String
)
it
.
next
(
)
;
final
Object
candidates
=
byNamespace
.
get
(
ns
)
;
if
(
candidates
==
null
)
{
byNamespace
.
put
(
ns
,
funcs
)
;
}
else
if
(
candidates
instanceof
Functions
)
{
final
List
lst
=
new
ArrayList
(
)
;
lst
.
add
(
candidates
)
;
lst
.
add
(
funcs
)
;
byNamespace
.
put
(
ns
,
lst
)
;
}
else
{
(
(
List
)
candidates
)
.
add
(
funcs
)
;
}
}
}
}
return
byNamespace
;
}
}
<EOF>
